{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análisis de Datasets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Estilos base que simulan un fondo oscuro (similar al del original) */
        body {
            background: linear-gradient(135deg, #1f2937, #4c1d95, #1f2937);
            color: #e2e8f0;
            min-height: 100vh;
        }
        .card-custom {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>

    <div class="container my-5">
        <div class="text-center mb-5">
            <h1 class="text-white fw-bold">Dashboard de Análisis de Datasets</h1>
            <p class="text-secondary">Analiza la calidad de tus datos y toma decisiones informadas</p>
        </div>

        <div class="card card-custom p-4 mb-5">
            <div class="row justify-content-center">
                <div class="col-md-8 text-center">
                    <i data-lucide="upload" class="mb-3 text-info" style="width: 48px; height: 48px;"></i>
                    <form id="uploadForm">
                        <div class="mb-3">
                            <label for="csvFile" class="btn btn-lg btn-primary" style="background: linear-gradient(to right, #9333ea, #db2777); border: none;">
                                Seleccionar CSV
                            </label>
                            <input type="file" id="csvFile" accept=".csv" class="d-none" required>
                        </div>
                        
                        <div id="fileInfo" class="text-center bg-dark p-3 rounded mb-3" style="display: none;">
                            <p class="text-white fw-bold" id="fileName"></p>
                            <p class="text-secondary small" id="fileSize"></p>
                        </div>

                        <button type="submit" id="analyzeBtn" class="btn btn-lg btn-success" style="background: linear-gradient(to right, #059669, #14b8a6); border: none;" disabled>
                            <i data-lucide="database" class="me-2" style="width: 20px; height: 20px;"></i>
                            Analizar Dataset
                        </button>
                        
                        <div id="loading" class="mt-3 text-center" style="display: none;">
                            <div class="spinner-border text-info" role="status"></div>
                            <div class="text-secondary small mt-2">Analizando... Esto puede tomar unos momentos</div>
                            </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div id="error" class="alert alert-danger" style="display: none;"></div>

        <div id="results" class="row g-4" style="display: none;">
            
            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h3 class="card-title text-white mb-4"><i data-lucide="info" class="me-2"></i>Información Básica</h3>
                    <div class="d-flex justify-content-between mb-2"><span class="text-secondary">Filas:</span><span class="text-white fw-bold" id="infoRows"></span></div>
                    <div class="d-flex justify-content-between mb-2"><span class="text-secondary">Columnas:</span><span class="text-white fw-bold" id="infoCols"></span></div>
                    <div class="d-flex justify-content-between mb-2"><span class="text-secondary">Tamaño:</span><span class="text-white fw-bold" id="infoSize"></span></div>
                    
                    <h4 class="text-white mt-4 mb-3">Tipos de Datos</h4>
                    <div style="height: 250px;"><canvas id="dataTypeChart"></canvas></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h3 class="card-title text-white mb-4">Métricas de Calidad</h3>
                    <div id="qualityMetrics" class="mb-4">
                        </div>
                    <h4 class="text-white mt-4 mb-3">Distribución de Calidad</h4>
                    <div style="height: 250px;"><canvas id="qualityBarChart"></canvas></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h3 class="card-title text-white mb-4">Valores Faltantes</h3>
                    <div class="text-center mb-4">
                        <span class="text-danger fw-bold fs-4" id="missingTotal"></span>
                        <p class="text-secondary small">Total Missing Percentage</p>
                    </div>
                    <div style="height: 300px;"><canvas id="missingDataChart"></canvas></div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h3 class="card-title text-white mb-4">Datos Duplicados</h3>
                    <div class="text-center mb-4">
                        <div class="text-warning fs-3 fw-bold" id="dupCount"></div>
                        <div class="text-secondary small" id="dupPerc"></div>
                    </div>
                    <h4 class="text-white mt-4 mb-3">Columnas Contribuyentes:</h4>
                    <div id="dupCols" class="small"></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h3 class="card-title text-white mb-4">Valores Atípicos</h3>
                    <div style="height: 300px;"><canvas id="outliersChart"></canvas></div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card card-custom p-4 h-100">
                    <h3 class="card-title text-white mb-4">Correlaciones Principales</h3>
                    <div style="height: 300px;"><canvas id="correlationChart"></canvas></div>
                </div>
            </div>

        </div>

        <div id="recommendationsSection" class="card card-custom p-4 mt-4" style="display: none;">
            <h3 class="card-title text-white mb-4">Recomendaciones de Tratamiento</h3>
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="bg-danger bg-opacity-25 rounded p-3 border border-danger"><h4 class="text-danger">Crítico</h4><ul id="recCritical" class="list-unstyled small mt-2"></ul></div>
                </div>
                <div class="col-md-4">
                    <div class="bg-warning bg-opacity-25 rounded p-3 border border-warning"><h4 class="text-warning">Moderado</h4><ul id="recModerate" class="list-unstyled small mt-2"></ul></div>
                </div>
                <div class="col-md-4">
                    <div class="bg-success bg-opacity-25 rounded p-3 border border-success"><h4 class="text-success">Opcional</h4><ul id="recOptional" class="list-unstyled small mt-2"></ul></div>
                </div>
            </div>
        </div>

    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Inicializar Lucide Icons al cargar la página
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            // Deshabilitar botón de analizar hasta seleccionar archivo
            document.getElementById('analyzeBtn').disabled = true;
        });
    </script>
    <script>
        // --------------------------------------------------------------------------------
        // JS Vanilla para la Lógica del Dashboard y Gráficos (Simulando Dashboard.js)
        // --------------------------------------------------------------------------------
        const form = document.getElementById('uploadForm');
        const fileInput = document.getElementById('csvFile');
        const fileInfoDiv = document.getElementById('fileInfo');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const resultsDiv = document.getElementById('results');
        const recommendationsSection = document.getElementById('recommendationsSection');
        const API_UPLOAD_ENDPOINT = "{{ api_upload_url }}"; 


        // Referencias de Chart.js
        let chartInstances = {};
        const CHART_COLORS = ['#8884d8', '#82ca9d', '#ffc658', '#ff7300', '#00ff88', '#ff0088'];
        
        // --- 1. Manejo de Archivo Seleccionado ---
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                // Validaciones básicas
                if (!file.name.toLowerCase().endsWith('.csv') || file.size > 50 * 1024 * 1024) {
                    errorDiv.textContent = 'Archivo no válido (solo CSV < 50MB)';
                    errorDiv.style.display = 'block';
                    analyzeBtn.disabled = true;
                    fileInfoDiv.style.display = 'none';
                    return;
                }
                
                // Mostrar info del archivo
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileSize').textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                fileInfoDiv.style.display = 'block';
                errorDiv.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        });
        

        // --- 2. Enviar para Análisis ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const file = fileInput.files[0];
            if (!file) return;

            // Limpiar y mostrar carga
            errorDiv.style.display = 'none';
            resultsDiv.style.display = 'none';
            recommendationsSection.style.display = 'none';
            loadingDiv.style.display = 'block';
            analyzeBtn.disabled = true;

            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(API_UPLOAD_ENDPOINT, { 
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': getCookie('csrftoken') } 
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al analizar el dataset');
                }

                displayDashboard(data.analysis);

            } catch (error) {
                errorDiv.textContent = 'Error: ' + error.message;
                errorDiv.style.display = 'block';
            } finally {
                loadingDiv.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        });
        
        // --- 3. Renderizado de Gráficos y Datos ---

        function displayDashboard(analysis) {
            // Limpiar gráficos anteriores
            Object.values(chartInstances).forEach(chart => chart.destroy());
            
            // Renderizar la información básica
            document.getElementById('infoRows').textContent = analysis.basic_info.total_rows.toLocaleString();
            document.getElementById('infoCols').textContent = analysis.basic_info.total_columns;
            document.getElementById('infoSize').textContent = analysis.basic_info.file_size;

            // Renderizar todos los gráficos
            renderDataTypeChart(analysis.basic_info.data_types);
            renderQualityBarChart(analysis.data_quality);
            renderMissingData(analysis.missing_data);
            renderDuplicates(analysis.duplicates);
            renderOutliers(analysis.outliers);
            renderCorrelation(analysis.correlation_matrix);
            renderRecommendations(analysis.recommendations);
            
            // Mostrar las secciones
            resultsDiv.style.display = 'flex';
            recommendationsSection.style.display = 'block';
            lucide.createIcons(); // Vuelve a inicializar iconos en el contenido nuevo
        }
        
        // Función auxiliar para obtener el CSRF token (Requerido por Django para POST)
        function getCookie(name) {
            // Implementación estándar de Django para obtener CSRF token
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // --- Funciones de Gráficos (Chart.js) ---

        function renderDataTypeChart(dataTypes) {
            const labels = Object.keys(dataTypes);
            const data = Object.values(dataTypes);

            chartInstances.dataTypeChart = new Chart(document.getElementById('dataTypeChart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: CHART_COLORS,
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    plugins: { legend: { labels: { color: '#e2e8f0' } } } 
                }
            });
        }
        
        function renderQualityBarChart(dataQuality) {
            const labels = Object.keys(dataQuality).map(key => key.charAt(0).toUpperCase() + key.slice(1).replace('_', ' '));
            const data = Object.values(dataQuality);

            // Inyectar métricas de calidad en formato de lista para mantener el estilo
            const qualityHtml = labels.map((label, index) => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div class="d-flex align-items-center">
                        <i data-lucide="${data[index] >= 90 ? 'check-circle' : 'alert-triangle'}" 
                           class="${data[index] >= 90 ? 'text-success' : 'text-warning'} me-2" style="width: 18px; height: 18px;"></i>
                        <span class="text-secondary">${label}</span>
                    </div>
                    <span class="fw-bold text-${data[index] >= 90 ? 'success' : data[index] >= 70 ? 'warning' : 'danger'}">
                        ${data[index].toFixed(1)}%
                    </span>
                </div>
            `).join('');
            document.getElementById('qualityMetrics').innerHTML = qualityHtml;
            
            chartInstances.qualityBarChart = new Chart(document.getElementById('qualityBarChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Puntuación (%)',
                        data: data,
                        backgroundColor: '#8b5cf6',
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true, max: 100, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#e2e8f0' }, grid: { display: false } } } 
                }
            });
        }
        
        function renderMissingData(missingData) {
            const labels = missingData.columns_with_missing.map(item => item.column);
            const data = missingData.columns_with_missing.map(item => item.percentage);
            
            document.getElementById('missingTotal').textContent = missingData.total_missing_percentage.toFixed(2) + '%';
            
            chartInstances.missingDataChart = new Chart(document.getElementById('missingDataChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Missing (%)',
                        data: data,
                        backgroundColor: '#ef4444',
                    }]
                },
                options: { 
                    indexAxis: 'y', // Bar horizontal
                    responsive: true, maintainAspectRatio: false, 
                    scales: { y: { ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } } 
                }
            });
        }
        
        function renderDuplicates(duplicates) {
            document.getElementById('dupCount').textContent = duplicates.total_duplicates.toLocaleString();
            document.getElementById('dupPerc').textContent = `${duplicates.percentage}% del dataset`;
            
            const colsHtml = duplicates.columns_contributing.map(col => 
                `<span class="badge bg-dark text-white">${col}</span>`
            ).join(' ');
            document.getElementById('dupCols').innerHTML = colsHtml || 'No hay columnas contribuyentes identificadas.';
        }

        function renderOutliers(outliers) {
            const labels = outliers.columns_with_outliers.map(item => item.column);
            const data = outliers.columns_with_outliers.map(item => item.outlier_count);
            
            chartInstances.outliersChart = new Chart(document.getElementById('outliersChart'), {
                type: 'bar', // Usamos barra ya que scatter requiere dos ejes numéricos que el mock no da
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Conteo de Outliers',
                        data: data,
                        backgroundColor: '#fbbf24',
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#e2e8f0' }, grid: { display: false } } } 
                }
            });
        }

        function renderCorrelation(correlationMatrix) {
            const labels = correlationMatrix.map(item => `${item.var1} vs ${item.var2}`);
            const data = correlationMatrix.map(item => item.correlation);
            
            chartInstances.correlationChart = new Chart(document.getElementById('correlationChart'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Correlación',
                        data: data,
                        backgroundColor: '#06b6d4',
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: false, ticks: { color: '#e2e8f0' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, x: { ticks: { color: '#e2e8f0' }, grid: { display: false } } } 
                }
            });
        }
        
        function renderRecommendations(recommendations) {
            const renderList = (id, recs) => {
                const ul = document.getElementById(id);
                ul.innerHTML = recs.map(rec => `<li>&bull; ${rec.description}</li>`).join('');
            };
            
            renderList('recCritical', recommendations.critical || []);
            renderList('recModerate', recommendations.moderate || []);
            renderList('recOptional', recommendations.optional || []);
        }
        
    </script>
</body>
</html>